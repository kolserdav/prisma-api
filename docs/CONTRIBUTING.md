# Инструкция для разработчика

Инструкция для разработчика бекенда, здесь описаны детали проекта для лучшего понимания кода.

## Ссылки

- [API документация](./API.md)
- [Лог изменений](./CHANGELOG.md)
- [Инструкция по установке](../README.md)
- [Лицензия](../LICENSE.md)

## Описание

Данный проект написан в инновационном стиле связи клиентской и серверной части приложение. Простыми словами, апи запросов на этот сервер основаны на апи `ORM PrismaJS` [https://github.com/prisma/prisma](https://github.com/prisma/prisma).

_В самом коде проставлены комментарии с описанием неочевидных моментов, то что описано там, здесь дублироваться не будет, здесь описываем только фундаментальные моменты._

## Требования

- Javascript ES6 (async await, let const, () => {}, d = d ? d : null, const { d } = a) - опыт
- Typescript - опыт или желание разобраться

## Среда разработки

**Настоятельно рекомендуется использовать VSCode**

### Расширения VSCode

- prisma.prisma - синтаксис orm/prisma.schema
- dbaeumer.vscode-eslint - подсветка правил eslint
- esbenp.prettier-vscode - подстветка правил prettier
- humao.rest-client - выполнение запросов

## Установка

Базовая установка не отличается от того что описано в [инструкции по установке](../README.md#установка) отличается только сборка и запуск.

### Глобальные пакеты node.js

Для разработки

```
nodemon v^2.0.7
prisma v^2.21.1
```

## Сборка и запуск

Для отслеживания изменений и пересборки:

```
yarn dev:watch
```

Для запуска сервера и авто перезапуска при изменениях

```
yarn dev:start
```

## Создание миграций

Чтобы создань миграцию после изменений в `orm/schena.prisma`:

```
yarn migrate:dev
```

Скрипт выполнит следующую последовательность, элементы которой можно запускать и поотдельности см. раздел scripts [package.json](../package.json#scripts):

- `yarn format` - проверяет и редактирует файл схемы
- `yarn generate` - генерирует типы схемы для `@prisma/client`
- `prisma migrate dev --preview-feature` - создает и проводит в базу новую миграцию, директиву сохраняет в папку `orm/migrations` и в таблицу базы `prisma_migrations`.

Быстрый просмотр данных в базе

```
yarn studio
```

Когда миграция не проводится из-за конфликта с уже загруженными данными, нужно либо руками удалить эти данные из базы, либо сделать сброс коммандой:

```
yarn migrate:reset
```

## Архитектура

Каждый файл является отдельным узким модулем, задача которого описана в комментарии в верху файла, чтобы добавление новых апи сводилось к копипасту старых с небольшими изменениями, так, чтобы при желании, и программист фронтенда сам мог разобраться и дорабатывать бекенд; и это не сломало бы остальную логику. Такого удалось добиться благодаря переносу логики составления параметров выборок с бекенда на фронтенд. Чтобы разработчик бекенда не делал из одного апи узла "швейцарский нож", а разработчик фронтенда имел почти такой же выбор мариантов, как на бекенде.
Желательно соблюдать архитектуру и в будущем. Тогда новым разработчикам, пришедшим на проект будет проще разобраться в деталях и эффективно приступить к работе.

## Производительность

Изначально планировалось использование `fastify` вместо `express`, чтобы извлечь максимальную скорость от веб сервера на ноде, но к сожалению, не удалось подружить типы обработчиков запросов с типами `prisma`. Однако ввиду того, что здесь грамотный фронтенд разработчик будет выбирать данные так, чтобы каждый запрос весил как можно меньше, то это даст не только снижение нагрузки на сеть и память сервера (процесс), но и на память сервера базы данных, так как свойство `select` вернет не только с сервера, только то что там указано, но и из базы данных серверу. Такого нельзя добиться на связке `prisma` + `graphql` из коробки. Поэтому, есть все основания считать, что данное приложение будет работать немного быстрее и легче, чем приложения на `express` без использования API `prisma`.

## Проблемы кода

Архитектура кода составлялась на основе многочисленных проектов с учетом всех лучших практик. Однако ввиду того, что в этом проекте используется инновационных подход (параметры для базы данных составляются на фронтенде), то здесь накладываются дополнительные заботы о безопасности, которые отражаются в глобальных посредниках `src/middleware/index.ts` и в локальных посредников в файле обработчика каждого роута в отдельности. На момент написания, проверены возможные дыры в безопасности и приняты соответствующие меры, однако стоит не забывать, что пользователь может передать в параметрах потенциально опасные значения в том случае, если мы сами в обработчике или в посреднике оперируем переданными параметрами. И если призма получит нехорошие параметры она сама с ними разберется, а вот если мы попытаемся вызвать то чего не передано. То в коде выкинет исключение `unhandledRejection`, а текущий запрос будет прерван.

## Дополнительная нагрузка

- Взязи с инновационным подходом, было принято решение создавать файл [../src/api.d.ts](../src/api.d.ts) в котором приводить интерфейсы генерик методов для фронтенда. **связанный файл [src/prisma.d.ts](../src/prisma.d.ts) копируется автоматически при выполнении комманды:**

```
yarn dev:build
```

**Настоятельно рекомендуется выполнять эту комманду перед каждым коммитом, чтобы предотвратить ошибки сборки на сервере!**
